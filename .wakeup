#!/bin/zsh

. ~/.zshrc

SLEEP_WATCHER_DIRECTORY="$HOME/.sleepwatcher"
SLEEP_INFO="$SLEEP_WATCHER_DIRECTORY/slept_at"
if [ ! -d "$SLEEP_WATCHER_DIRECTORY" ]; then
  mkdir $SLEEP_WATCHER_DIRECTORY
fi

SLEPT_AT=$(cat $SLEEP_INFO)
START=$(date +"%s")
SLEEP_THRESHOULD=21600 # 6 hours
ANKI_DURATION=1800 # 30 mins
ANKI_END_AT=$(expr $START + $ANKI_DURATION)

if [ $(expr $START - $SLEPT_AT) -gt $SLEEP_THRESHOULD ]; then # if wake up
  # do Anki for $ANKI_DURATION
  terminal-notifier -title 'Anki' -message "$(expr $ANKI_DURATION / 60)分のAnkiタイムスタート"
  osascript -e 'activate application "Anki"'
  while [ $(date +"%s") -lt $ANKI_END_AT ]
  do
    ACTIVE_APP=$(osascript -e 'name of (info for (path to frontmost application))')
    if [ "$ACTIVE_APP" != 'Anki.app' ]; then
      terminal-notifier -title 'おい！' -message 'Ankiやれ'
      osascript -e 'activate application "Anki"'
    fi
    sleep 5
  done

  # make a daily plan
  terminal-notifier -title 'emacs' -message '一日の予定をたてよう'
  emacsclient --no-wait ~/org/gtd.org
fi
